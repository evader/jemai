\nimport os, sys, subprocess, shutil\n\ndef jemai_upgrade_try(new_code):\n    bakdir = os.path.expanduser(\"~/.jemai_versions\")\n    os.makedirs(bakdir, exist_ok=True)\n    old_path = os.path.realpath(__file__)\n    bak = os.path.join(bakdir, f\"jemai_{int(time.time())}.py\")\n    shutil.copy2(old_path, bak)\n\n    testfile = os.path.join(bakdir, \"jemai_test.py\")\n    with open(testfile, \"w\") as f:\n        f.write(new_code)\n    print(\"[JEMAI] Looks like new code. Attempting auto-upgrade...\")\n\n    # --- Fix: always run with JEMAI_UPGRADE_TEST=1 ---\n    try:\n        result = subprocess.run(\n            [sys.executable, testfile],\n            env=dict(os.environ, JEMAI_UPGRADE_TEST=\"1\"),\n            capture_output=True, text=True, timeout=5\n        )\n        if \"JEMAI SMOKETEST OK\" in result.stdout:\n            with open(old_path, \"w\") as f:\n                f.write(new_code)\n            print(\"[JEMAI] Upgrade applied! \ud83c\udf89\")\n            sys.exit(0)\n        else:\n            print(f\"[JEMAI] Smoke test error: {result.stdout or result.stderr}\")\n            print(\"[JEMAI] Upgrade failed! Code not applied. Staying alive.\")\n    except Exception as e:\n        print(f\"[JEMAI] Upgrade failed: {e}\")\n\n# Then, in your main loop, when pasting new code, call jemai_upgrade_try(new_code)\n