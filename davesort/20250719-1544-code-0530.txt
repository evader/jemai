# JEM AI - Production Docker Compose (V1.2 - Fully Variable-Driven)
    services:
      jemai_core:
        build: .
        container_name: jemai_prod_core
        ports:
          - "5000:5000"
        volumes:
          - ".:/app" 
          - "/var/run/docker.sock:/var/run/docker.sock"
          - "${PROD_RAG_DATA_DIR}:/app/rag/chroma_data"
          - ollama_prod_data:/root/.ollama
        deploy:
          resources:
            reservations:
              devices:
                - driver: nvidia
                  count: all
                  capabilities: [gpu]
        restart: unless-stopped
        environment:
          - OLLAMA_HOST=${OLLAMA_HOST}

      # We are bringing back the other services into this unified compose file.
      # They were in the Genesis Installer's generated file, let's restore them.
      open-webui:
        image: ghcr.io/open-webui/open-webui:main
        container_name: jemai_prod_open_webui
        ports:
          - "3000:8080"
        depends_on:
          - jemai_core # It will talk to the Ollama library inside jemai_core
        environment:
          # Open WebUI needs to talk to the Ollama API, which is now inside jemai_core
          - OLLAMA_BASE_URL=http://jemai_core:11434 
        restart: unless-stopped
      
      jupyter:
        image: jupyter/tensorflow-notebook:latest
        container_name: jemai_prod_jupyter
        ports:
          - "8888:8888"
        volumes:
          - "${USER_NOTEBOOKS_DIR}:/home/jovyan/work"
        environment:
          - JUPYTER_ENABLE_LAB=yes
          - JUPYTER_TOKEN=${JUPYTER_TOKEN}
        restart: unless-stopped
        deploy:
          resources:
            reservations:
              devices:
                - driver: nvidia
                  count: all
                  capabilities: [gpu]

      code-server:
        image: codercom/code-server:latest
        container_name: jemai_prod_code_server
        ports:
          - "8080:8080"
        volumes:
          - "${USER_PROJECTS_DIR}:/home/coder/projects"
          - "/var/run/docker.sock:/var/run/docker.sock"
        environment:
          - PASSWORD=${CODE_SERVER_PASSWORD}
          - DOCKER_HOST=unix:///var/run/docker.sock
        restart: unless-stopped

      portainer:
        image: portainer/portainer-ce:latest
        container_name: jemai_prod_portainer
        ports:
          - "9000:9000"
        volumes:
          - "/var/run/docker.sock:/var/run/docker.sock"
          - portainer_data:/data
        restart: unless-stopped

    volumes:
      ollama_prod_data:
      portainer_data: # Added missing volume definition